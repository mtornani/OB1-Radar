<script>
  const state = { data:null, items:[], q:"", type:"", tag:"", recentOnly:false };
  const $ = s => document.querySelector(s);

  function escapeHtml(s=''){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
  function timeToLocal(iso){try{const d=new Date(iso);return d.toLocaleString(undefined,{hour12:false})}catch{return iso||'—'}}
  function option(node,v,l){const o=document.createElement('option');o.value=v;o.textContent=l;node.appendChild(o)}

  function hydrateFiltersFromData(){
    const types=new Set(), tags=new Set();
    (state.data.items||[]).forEach(it=>{
      if(it.anomaly_type) types.add(it.anomaly_type);
      (it.why||[]).forEach(w=>{ if(w) tags.add(String(w).toLowerCase()); });
    });
    const typeSel=$('#type'), tagSel=$('#tag'); typeSel.innerHTML=''; tagSel.innerHTML='';
    option(typeSel,'','Anomaly type: tutti'); [...types].sort().forEach(t=>option(typeSel,t,t));
    option(tagSel,'','Tag: tutti'); [...tags].sort().forEach(t=>option(tagSel,t,t));
    typeSel.value=''; tagSel.value='';
  }

  function badge(t){ const s=document.createElement('span'); s.className='chip'; s.textContent=t; return s; }

  function card(it){
    const d=document.createElement('div'); d.className='card';
    d.innerHTML=`<div class="top"><div class="title">${escapeHtml(it.label||'—')}</div>
      <div class="score">${Number(it.score??0).toFixed(0)}</div></div>
      <div class="chips"></div>
      <div class="actions"><a class="btn" href="${(it.links&&it.links[0])||'#'}" target="_blank" rel="noopener">Apri fonte →</a></div>`;
    const box=d.querySelector('.chips'); (it.why||[]).forEach(w=>box.appendChild(badge(w)));
    return d;
  }

  function applyFilters(){
    const q=state.q.trim().toLowerCase(), type=state.type, tag=state.tag;
    const raw=(state.data.items||[]);
    const pass = it=>{
      if(type && it.anomaly_type!==type) return false;
      if(tag && !(it.why||[]).map(x=>String(x).toLowerCase()).includes(tag)) return false;
      if(state.recentOnly && !(it.why||[]).includes('recente')) return false;
      if(q){ const hay=`${it.label||''} ${(it.why||[]).join(' ')}`.toLowerCase(); if(!hay.includes(q)) return false; }
      return true;
    };
    let out=raw.filter(pass).sort((a,b)=>(b.score||0)-(a.score||0));

    // Fallback UX: se il filtro recenti azzera tutto, disattivalo e mostra hint
    if(state.recentOnly && out.length===0 && raw.length>0){
      state.recentOnly=false; $('#recentOnly').checked=false;
      const last=$('#last'); last.textContent += " — nessun item marcato 'recente'; filtro disattivato automaticamente.";
      out=raw.sort((a,b)=>(b.score||0)-(a.score||0));
    }

    state.items=out; render();
  }

  function render(){
    const list=$('#list'), empty=$('#empty'); list.innerHTML='';
    if(!state.items.length){ empty.style.display='block'; return; }
    empty.style.display='none'; state.items.forEach(it=> list.appendChild(card(it)));
  }

  async function buildArchive(){
    const today=new Date(); const cands=[];
    for(let i=0;i<10;i++){ const d=new Date(today); d.setDate(today.getDate()-i);
      const y=d.getUTCFullYear(), m=String(d.getUTCMonth()+1).padStart(2,'0'), dd=String(d.getUTCDate()).padStart(2,'0');
      cands.push(`daily-${y}-${m}-${dd}.json`);
    }
    const present=[]; await Promise.all(cands.map(async f=>{ try{ const r=await fetch(`${f}`,{cache:'no-store'}); if(r.ok) present.push(f);}catch{} }));
    if(present.length){ const el=$('#archive'); el.innerHTML='Archivio: '; present.slice(0,7).forEach(f=>{ const a=document.createElement('a'); a.href=f; a.textContent=f.replace('daily-','').replace('.json',''); a.target='_blank'; el.appendChild(a); }); }
  }

  async function boot(){
    try{
      const r=await fetch(`daily.json?t=${Date.now()}`,{cache:'no-store'});
      if(!r.ok) throw new Error(r.status);
      state.data=await r.json();
      $('#last').textContent=`Last updated: ${timeToLocal(state.data.generated_at_utc)} • items: ${state.data.items?.length??0}`;
      $('#mode').textContent=`mode: ${state.data.mode||'unknown'}`;
    }catch(e){
      state.data={items:[]}; $('#last').textContent='Last updated — errore nel fetch di daily.json';
    }
    hydrateFiltersFromData();
    // forza default OFF
    state.q=''; state.type=''; state.tag=''; state.recentOnly=false;
    $('#q').value=''; $('#type').value=''; $('#tag').value=''; $('#recentOnly').checked=false;
    applyFilters(); buildArchive();
  }

  $('#q').addEventListener('input',e=>{state.q=e.target.value; applyFilters();});
  $('#type').addEventListener('change',e=>{state.type=e.target.value; applyFilters();});
  $('#tag').addEventListener('change',e=>{state.tag=e.target.value; applyFilters();});
  $('#recentOnly').addEventListener('change',e=>{state.recentOnly=e.target.checked; applyFilters();});

  boot();
</script>
