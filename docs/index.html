<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OB1 · Ouroboros Radar — Top-10</title>
  <style>
    :root { --bg:#0b0d10; --fg:#e8eaed; --muted:#9aa0a6; --card:#15181c; --chip:#2a2f36; --accent:#4caf50; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;}
    .wrap{max-width:980px;margin:0 auto;padding:14px;}
    h1{font-size:18px;margin:6px 0 12px 0;font-weight:700}
    .topbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type="search"],select{background:#111419;border:1px solid #20242b;color:var(--fg);padding:10px;border-radius:10px;flex:1 1 220px;outline:none}
    .btn{padding:10px 12px;border-radius:10px;background:#1c2229;border:1px solid #2a333d;color:var(--fg);text-decoration:none}
    .btn:hover{filter:brightness(1.1)}
    .meta{font-size:12px;color:var(--muted);margin:8px 0}
    .list{display:flex;flex-direction:column;gap:10px;margin:10px 0 40px}
    .card{background:var(--card);border:1px solid #222831;border-radius:14px;padding:12px}
    .card .top{display:flex;justify-content:space-between;gap:10px}
    .title{font-weight:600}
    .score{background:#0f1a12;border:1px solid #1f3b26;color:#a7e3b5;border-radius:999px;padding:4px 10px;font-weight:700}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0}
    .chip{background:var(--chip);color:#c9d1d9;border-radius:999px;padding:4px 8px;font-size:12px}
    .actions{margin-top:8px}
    .empty{display:none;text-align:center;color:var(--muted);padding:40px 8px}
    .row{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .switch{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--muted)}
    .archive a{color:var(--muted);text-decoration:none;margin-right:10px}
    .hint{font-size:12px;color:var(--muted)}
    /* error overlay */
    #err { display:none; position:fixed; inset:0; background:rgba(0,0,0,.9); color:#fff; z-index:9999; }
    #err .box{max-width:900px;margin:40px auto;padding:14px}
    #err pre{white-space:pre-wrap;background:#1a1a1a;padding:12px;border-radius:10px;border:1px solid #333;overflow:auto}
  </style>
</head>
<body>
  <div id="err"><div class="box">
    <h2>⚠️ Errore JavaScript</h2>
    <p>La pagina ha incontrato un problema. Prova un “aggiorna” duro. Dettagli:</p>
    <pre id="errlog"></pre>
    <button class="btn" onclick="document.getElementById('err').style.display='none'">Chiudi</button>
  </div></div>

  <div class="wrap">
    <h1>OB1 · Ouroboros Radar — Top-10</h1>

    <div class="topbar">
      <input id="q" type="search" placeholder="Cerca (titolo, tag) …" />
      <select id="type"></select>
      <select id="tag"></select>
      <label class="switch"><input id="recentOnly" type="checkbox" /> Solo recenti (≤21gg)</label>
      <button id="reset" class="btn">Reset</button>
    </div>

    <div class="meta">
      <span id="last">Last updated —</span>
      &nbsp;•&nbsp;<span id="mode">mode —</span>
      &nbsp;•&nbsp;<span class="archive" id="archive"></span>
    </div>

    <div id="list" class="list"></div>
    <div id="empty" class="empty">Nessun risultato con questi filtri.<div class="hint">Suggerimento: premi <b>Reset</b> o togli “Solo recenti”.</div></div>
  </div>

  <script>
  (function(){
    // --- Safe helpers (niente ?. / ??) ---
    function safe(obj, path, def) {
      try {
        var segs = path.split('.');
        for (var i=0;i<segs.length;i++) {
          if (obj == null) return def;
          obj = obj[segs[i]];
        }
        return (obj==null ? def : obj);
      } catch(e){ return def; }
    }
    function $(s){return document.querySelector(s);}
    function esc(s){return String(s||'').replace(/[&<>"']/g,function(m){return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]);});}
    function toLocal(iso){try{var d=new Date(iso); return d.toLocaleString(undefined,{hour12:false});}catch(e){return iso||'—';}}

    var state = { data:null, items:[], q:'', type:'', tag:'', recentOnly:false };

    function badge(t){ var s=document.createElement('span'); s.className='chip'; s.textContent=t; return s; }
    function card(it){
      var d=document.createElement('div'); d.className='card';
      var score = Math.round(Number(it && it.score || 0));
      d.innerHTML = '<div class="top"><div class="title">'+esc(it && it.label)+'</div>'
                   + '<div class="score">'+score+'</div></div>'
                   + '<div class="chips"></div>'
                   + '<div class="actions"><a class="btn" target="_blank" rel="noopener" href="'+esc((it && it.links && it.links[0])||"#")+'">Apri fonte →</a></div>';
      var box = d.querySelector('.chips');
      var why = (it && it.why) || [];
      for (var i=0;i<why.length;i++) box.appendChild(badge(why[i]));
      return d;
    }

    function hydrateFilters(){
      var items = safe(state,'data.items',[]);
      var types = {}; var tags = {};
      for (var i=0;i<items.length;i++){
        var it=items[i];
        if (it && it.anomaly_type) types[it.anomaly_type]=1;
        var w = (it && it.why) || [];
        for (var j=0;j<w.length;j++) tags[String(w[j]).toLowerCase()]=1;
      }
      var typeSel=$('#type'), tagSel=$('#tag');
      typeSel.innerHTML=''; tagSel.innerHTML='';
      function opt(node,v,l){ var o=document.createElement('option'); o.value=v; o.textContent=l; node.appendChild(o); }
      opt(typeSel,'','Anomaly type: tutti');
      for (var k in types) opt(typeSel,k,k);
      opt(tagSel,'','Tag: tutti');
      var allTags = Object.keys(tags).sort();
      for (var t=0;t<allTags.length;t++) opt(tagSel,allTags[t],allTags[t]);
      typeSel.value=''; tagSel.value='';
    }

    function applyFilters(){
      var q = (state.q||'').toLowerCase();
      var type = state.type||'';
      var tag = (state.tag||'').toLowerCase();
      var raw = safe(state,'data.items',[]);
      var out = [];
      for (var i=0;i<raw.length;i++){
        var it=raw[i]; if (!it) continue;
        if (type && it.anomaly_type!==type) continue;
        var whyLower = ((it.why||[]).join('◊')).toLowerCase();
        if (tag && whyLower.split('◊').indexOf(tag)===-1) continue;
        if (state.recentOnly && (it.why||[]).indexOf('recente')===-1) continue;
        if (q){
          var hay = (String(it.label||'')+' '+(it.why||[]).join(' ')).toLowerCase();
          if (hay.indexOf(q)===-1) continue;
        }
        out.push(it);
      }
      out.sort(function(a,b){ return (b.score||0)-(a.score||0); });

      // Fallback UX: se recentOnly svuota ma ci sono item → disattiva e avvisa
      if (state.recentOnly && out.length===0 && raw.length>0){
        state.recentOnly=false; $('#recentOnly').checked=false;
        var last=$('#last'); last.textContent += " — nessun item marcato 'recente'; filtro disattivato.";
        out = raw.slice().sort(function(a,b){return (b.score||0)-(a.score||0);});
      }

      state.items = out;
      render();
    }

    function render(){
      var list=$('#list'), empty=$('#empty');
      list.innerHTML='';
      if (!state.items.length){ empty.style.display='block'; return; }
      empty.style.display='none';
      for (var i=0;i<state.items.length;i++) list.appendChild(card(state.items[i]));
    }

    function buildArchive(){
      var today=new Date(), cands=[];
      for (var i=0;i<10;i++){
        var d=new Date(today.getTime()); d.setDate(today.getDate()-i);
        var y=d.getUTCFullYear(), m=("0"+(d.getUTCMonth()+1)).slice(-2), dd=("0"+d.getUTCDate()).slice(-2);
        cands.push("daily-"+y+"-"+m+"-"+dd+".json");
      }
      (function probe(idx,acc){
        if (idx>=cands.length){
          if (acc.length){ var el=$('#archive'); el.innerHTML='Archivio: ';
            for (var j=0;j<Math.min(acc.length,7);j++){ var a=document.createElement('a'); a.href=acc[j]; a.target="_blank"; a.textContent=acc[j].slice(6,-5); el.appendChild(a); }
          }
          return;
        }
        fetch(cands[idx],{cache:'no-store'}).then(function(r){
          if (r.ok) acc.push(cands[idx]);
          probe(idx+1,acc);
        }).catch(function(){ probe(idx+1,acc); });
      })(0,[]);
    }

    function boot(){
      // default filtri OFF
      state.q=''; state.type=''; state.tag=''; state.recentOnly=false;
      $('#q').value=''; $('#type').value=''; $('#tag').value=''; $('#recentOnly').checked=false;

      fetch("daily.json?t="+Date.now(),{cache:'no-store'})
        .then(function(r){ if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); })
        .then(function(j){
          state.data = j || {items:[]};
          $('#last').textContent = "Last updated: " + toLocal(safe(j,'generated_at_utc','')) + " • items: " + (safe(j,'items',[]).length);
          $('#mode').textContent = "mode: " + (j && j.mode || 'unknown');
          hydrateFilters(); applyFilters(); buildArchive();
        })
        .catch(function(err){
          state.data = {items:[]};
          $('#last').textContent = "Last updated — errore nel fetch di daily.json";
          hydrateFilters(); applyFilters(); // mostra empty state
          // mostra overlay errore
          var msg = (err && (err.stack||err.message)) || String(err);
          document.getElementById('errlog').textContent = msg;
          document.getElementById('err').style.display = 'block';
        });
    }

    // eventi UI
    $('#q').addEventListener('input',function(e){ state.q=e.target.value; applyFilters(); });
    $('#type').addEventListener('change',function(e){ state.type=e.target.value; applyFilters(); });
    $('#tag').addEventListener('change',function(e){ state.tag=e.target.value; applyFilters(); });
    $('#recentOnly').addEventListener('change',function(e){ state.recentOnly=e.target.checked; applyFilters(); });
    $('#reset').addEventListener('click',function(){
      state.q=''; state.type=''; state.tag=''; state.recentOnly=false;
      $('#q').value=''; $('#type').value=''; $('#tag').value=''; $('#recentOnly').checked=false;
      applyFilters();
    });

    // catcher errori globali → overlay (debug mobile)
    window.addEventListener('error',function(e){
      try{
        document.getElementById('errlog').textContent = (e && e.error && (e.error.stack||e.error.message)) || (e && e.message) || String(e);
        document.getElementById('err').style.display = 'block';
      }catch(_){}
    });
    window.addEventListener('unhandledrejection',function(e){
      try{
        document.getElementById('errlog').textContent = (e && e.reason && (e.reason.stack||e.reason.message)) || String(e.reason||e);
        document.getElementById('err').style.display = 'block';
      }catch(_){}
    });

    boot();
  })();
  </script>
</body>
</html>