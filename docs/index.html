<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OB1 Radar • Top-10 anomalie</title>
  <style>
    :root { --pad: 14px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; background:#f5f5f7; color:#222; }
    header { padding: var(--pad); text-align:center; background:#fff; position:sticky; top:0; border-bottom:1px solid #eee; }
    h1 { margin:0; font-size:20px; }
    small { color:#666; font-weight:400; }
    .wrap { max-width: 860px; margin: 0 auto; padding: var(--pad); }
    .filters { display:flex; gap:8px; margin-bottom:10px; }
    .filters input, .filters select { flex:1; padding:10px; border:1px solid #ddd; border-radius:8px; background:#fff; }
    .item { background:#fff; border-radius:10px; padding:12px; margin:10px 0; border:1px solid #eee; }
    .ttl { display:flex; justify-content:space-between; align-items:center; font-weight:600; }
    .why { color:#555; font-size:14px; margin-top:4px; }
    .score { font-weight:700; }
    a { color:#5533cc; text-decoration:none; }
    a:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <header>
    <h1>OB1 Radar — Top-10 Anomalie <small id="ts"></small></h1>
  </header>

  <div class="wrap">
    <div class="filters">
      <input id="q" type="search" placeholder="Cerca (titolo/motivo)..." />
      <select id="entity">
        <option value="">Entity: tutte</option>
        <option value="PLAYER">PLAYER</option>
        <option value="TEAM">TEAM</option>
      </select>
      <select id="atype">
        <option value="">Tipo: tutti</option>
        <option value="NOISE_PULSE">NOISE_PULSE</option>
        <option value="PLAYER_BURST">PLAYER_BURST</option>
        <option value="TEAM_SHIFT">TEAM_SHIFT</option>
      </select>
    </div>
    <div id="list">Caricamento…</div>
  </div>

  <script>
    let RAW = [];
    const list = document.getElementById('list');

    function render() {
      const q = document.getElementById('q').value.trim().toLowerCase();
      const e = document.getElementById('entity').value;
      const t = document.getElementById('atype').value;
      const rows = RAW.filter(x => {
        const okQ = !q || (x.label?.toLowerCase().includes(q) || (x.why||[]).join(' ').toLowerCase().includes(q));
        const okE = !e || x.entity === e;
        const okT = !t || x.anomaly_type === t;
        return okQ && okE && okT;
      });
      list.innerHTML = rows.map(x => `
        <div class="item">
          <div class="ttl">
            <div>${x.label}</div>
            <div class="score">${x.score}</div>
          </div>
          <div class="why">${(x.why||[]).join(', ') || '&nbsp;'}</div>
          <div style="margin-top:6px">
            ${x.links?.[0] ? `<a href="${x.links[0]}" target="_blank" rel="noopener">Dettagli →</a>` : ''}
          </div>
        </div>
      `).join('') || 'Nessun risultato.';
    }

    fetch('daily.json?t=' + Date.now())
      .then(r => r.json())
      .then(data => {
        RAW = data.items || [];
        const ts = data.generated_at_utc || data.stamp || '';
        if (ts) document.getElementById('ts').textContent = `(${ts})`;
        render();
      })
      .catch(() => list.textContent = 'Errore nel caricamento.');

    document.getElementById('q').addEventListener('input', render);
    document.getElementById('entity').addEventListener('change', render);
    document.getElementById('atype').addEventListener('change', render);
  </script>
</body>
</html>
